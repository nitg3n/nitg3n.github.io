<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>카이사르 암호 챌린지</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
            background-color: #f0f2f5;
            background-image: linear-gradient(135deg, #e9ecf2 0%, #f7f8fa 100%);
        }

        .cipher-wheel-container {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .cipher-wheel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .outer-wheel {
            background-color: #f7fafc;
            border: 2px solid #a0aec0;
            width: 100%;
            height: 100%;
        }

        .inner-wheel {
            background-color: #cbd5e0;
            width: 75%;
            height: 75%;
            border: 2px solid #718096;
            transition: transform 0.4s ease-in-out;
        }

        .letter {
            position: absolute;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            padding-top: 6px;
            width: 20px;
            height: 280px;
            top: 0;
            left: calc(50% - 10px);
            transform-origin: center center;
            color: #2d3748;
        }


        .outer-letter>span {
            color: #4a5568;
        }

        .inner-letter {
            height: 210px;
        }

        .inner-letter-text {
            display: inline-block;
            transition: transform 0.4s ease-in-out;
        }

        .key-display {
            background-color: #edf2f7;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 700;
            color: #2d3748;
            border: 2px solid #cbd5e0;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .btn {
            @apply px-6 py-3 rounded-lg font-bold text-white shadow-md transition-all duration-300 transform;
        }

        .btn-blue {
            @apply bg-blue-500 hover:bg-blue-600 active:scale-95;
        }

        .btn-green {
            @apply bg-green-500 hover:bg-green-600 active:scale-95;
        }

        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-600 active:scale-95;
        }

        .btn-teal {
            @apply bg-teal-500 hover:bg-teal-600 active:scale-95;
        }

        .name-input:focus {
            @apply ring-2 ring-blue-400 border-transparent;
        }

        .feedback-correct {
            animation: correct-pulse 0.5s;
        }

        .feedback-incorrect {
            animation: incorrect-shake 0.5s;
        }

        .btn-control {
            @apply w-12 h-12 rounded-full bg-gray-300 hover:bg-gray-400 text-gray-800 text-2xl font-bold flex items-center justify-center transition-all duration-200 active:scale-90;
        }

        @keyframes correct-pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes incorrect-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }
        
        @keyframes combo-pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15) rotate(-5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .combo-pop-animation {
            animation: combo-pop 0.3s ease-out;
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-4">

    <main id="app-container" class="w-full max-w-md mx-auto text-center my-auto">

        <div id="mode-selection-screen" class="bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold mb-2 text-gray-700">카이사르 암호 챌린지</h1>
            <p class="text-gray-500 mb-8">플레이할 챌린지를 선택하세요.</p>
            <div class="space-y-4">
                <button id="start-time-attack" class="btn btn-blue w-full text-lg">
                    ⏰ 암호 해독 타임어택!
                </button>
                <button id="start-find-key" class="btn btn-teal w-full text-lg">
                    🔑 키를 찾아라!
                </button>
                <button id="show-leaderboard-main" class="btn btn-gray w-full text-lg">
                    🏆 리더보드 보기
                </button>
                <button id="show-tutorial" class="btn btn-gray w-full text-lg">
                    📖 게임 방법
                </button>
            </div>
        </div>

        <div id="game-screen" class="hidden bg-white p-6 md:p-8 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <div class="text-left">
                    <span class="text-gray-500">점수</span>
                    <p id="score" class="text-3xl font-bold">0</p>
                </div>
                <div class="text-right">
                    <span class="text-gray-500">남은 시간</span>
                    <p id="timer" class="text-3xl font-bold">90</p>
                </div>
            </div>

            <div id="motivation-area" class="min-h-[24px] mb-4">
                <p id="motivational-message" class="text-sm text-center text-teal-600 font-medium"></p>
            </div>

            <div id="combo-area" class="min-h-[36px] mb-2">
                <p id="combo-display" class="text-2xl font-bold text-red-500 hidden"></p>
            </div>

            <div class="cipher-wheel-container mx-auto mb-4">
                <div class="cipher-wheel outer-wheel"></div>
                <div id="inner-wheel" class="cipher-wheel inner-wheel"></div>
            </div>

            <div id="shift-control" class="flex items-center justify-center space-x-4 mb-6">
                <button id="decrease-shift" class="btn-control">-</button>
                <span id="user-shift-display" class="key-display text-lg">이동 값: +0</span>
                <button id="increase-shift" class="btn-control">+</button>
            </div>

            <div id="problem-area" class="mb-6">
                <p id="instruction" class="text-gray-500 mb-2"></p>
                <p id="problem-key-display" class="key-display text-lg mb-4 inline-block hidden">Key: +3</p>
                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2">
                    <p id="encrypted-word"
                        class="text-3xl sm:text-4xl font-bold tracking-widest bg-gray-100 p-3 sm:p-4 rounded-lg"></p>
                    <div id="arrow-display" class="hidden">
                        <svg class="w-8 h-8 text-gray-500 transform rotate-90 sm:rotate-0" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </div>
                    <p id="original-word-display"
                        class="text-3xl sm:text-4xl font-bold tracking-widest bg-green-100 p-3 sm:p-4 rounded-lg hidden">
                    </p>
                </div>
            </div>

            <div id="answer-area">
                <input type="text" id="answer-input"
                    class="w-full p-4 text-2xl text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
                    placeholder="정답 입력" autocomplete="off" autocapitalize="off">
                <p id="action-guidance-message" class="text-sm mt-2 text-gray-500 h-5"></p>
                <button id="submit-answer-btn"
                    class="w-full mt-4 px-6 py-3 rounded-full font-bold text-lg text-gray-800 border-2 border-gray-800 hover:bg-gray-800 hover:text-white transition-all duration-300 transform active:scale-95 hidden">정답
                    제출</button>
                <button id="check-key-btn"
                    class="w-full mt-4 px-6 py-3 rounded-full font-bold text-lg text-gray-800 border-2 border-gray-800 hover:bg-gray-800 hover:text-white transition-all duration-300 transform active:scale-95 hidden">이
                    키로 확인</button>
            </div>
        </div>
    </main>

    <div id="game-over-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-sm p-8 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-3xl font-bold mb-2">게임 종료!</h2>
            <p class="text-lg mb-4">최종 점수: <span id="final-score" class="font-bold text-blue-500">0</span></p>
            <div class="mb-4">
                <input type="text" id="leaderboard-name"
                    class="name-input w-full p-3 text-center border-2 border-gray-300 rounded-lg focus:outline-none transition"
                    placeholder="리더보드에 등록할 이름">
                <button id="submit-score" class="btn btn-green w-full mt-2">점수 등록</button>
            </div>
            <div class="flex space-x-2">
                <button id="play-again" class="btn btn-blue flex-1">다시하기</button>
                <button id="share-score" class="btn btn-teal flex-1">공유하기</button>
            </div>
            <button id="show-leaderboard" class="btn btn-gray w-full mt-2">리더보드 보기</button>
        </div>
    </div>
    <div id="leaderboard-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-sm p-6 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-4">🏆 리더보드 🏆</h2>
            <div id="leaderboard-content" class="text-left max-h-80 overflow-y-auto">
                <p class="text-center text-gray-500">로딩 중...</p>
            </div>
            <button id="close-leaderboard" class="btn btn-gray w-full mt-4">닫기</button>
        </div>
    </div>
    <div id="tutorial-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-md p-8 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-3xl font-bold mb-4">📖 게임 방법</h2>
            <div class="text-left space-y-6 text-gray-700">
                <div>
                    <strong class="text-blue-500 text-xl">⏰ 암호 해독 타임어택!</strong>
                    <p class="mt-2">
                        <strong>목표</strong>: <strong class="font-mono bg-red-200 px-1 rounded">암호문</strong>과 <strong 
                        class="font-mono bg-blue-200 px-1 rounded">키</strong>를 보고 <strong 
                        class="font-mono bg-green-200 px-1 rounded">원래의 단어</strong>를 맞히는 게임!
                    </p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>화면에 나오는 <strong class="font-mono bg-red-200 px-1 rounded">암호문</strong>과 <strong
                                class="font-mono bg-blue-200 px-1 rounded">키</strong>를 확인하세요.</li>
                        <li><strong class="font-mono bg-blue-200 px-1 rounded">키</strong>만큼 알파벳을 <strong>반대로</strong> 밀어서 <strong 
                        class="font-mono bg-green-200 px-1 rounded">원래의 단어</strong>를
                            추리합니다. (예: 키가 +3일 때 암호 D는 A가 됩니다)</li>
                        <li>정답을 빠르게 입력해서 높은 점수를 얻어보세요!</li>
                    </ul>
                </div>
                <div>
                    <strong class="text-teal-500 text-xl">🔑 키를 찾아라!</strong>
                    <p class="mt-2">
                        <strong>목표</strong>: <strong class="font-mono bg-red-200 px-1 rounded">암호문</strong>과 <strong 
                        class="font-mono bg-green-200 px-1 rounded">원래의 단어</strong>를 보고 둘을 연결하는 비밀 <strong 
                        class="font-mono bg-blue-200 px-1 rounded">키</strong>를 찾는 게임!
                    </p>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong class="font-mono bg-red-200 px-1 rounded">암호문</strong>과 <strong
                                class="font-mono bg-green-200 px-1 rounded">원래의 단어</strong>가 동시에 나옵니다.</li>
                        <li><strong class="font-mono bg-gray-200 px-1 rounded">+</strong> / <strong
                                class="font-mono bg-gray-200 px-1 rounded">-</strong> 버튼으로 암호판을 돌려, 두 단어가 딱 맞도록 조준하세요.
                        </li>
                        <li>정답 <strong class="font-mono bg-blue-200 px-1 rounded">키</strong>를 찾았다면 확인 버튼을 눌러 점수를 획득!
                        </li>
                    </ul>
                </div>
            </div>
            <li>궁금한 점 있으시면 편히 질문해 주세요!</li>
            <button id="close-tutorial"
                class="w-full mt-8 px-6 py-3 rounded-full font-bold text-lg text-gray-800 border-2 border-gray-800 hover:bg-gray-800 hover:text-white transition-all duration-300 transform active:scale-95">이해했어요!</button>
        </div>
    </div>
    <div id="share-toast"
        class="hidden fixed bottom-10 left-1/2 -translate-x-12 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm">
        클립보드에 복사되었습니다!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArTDw-8Gw9wjhQbhWySalh1kS7_heePRY",
            authDomain: "ceaser-board.firebaseapp.com",
            projectId: "ceaser-board",
            storageBucket: "ceaser-board.firebasestorage.app",
            messagingSenderId: "597014903425",
            appId: "1:597014903425:web:e85e8f9e4bea419aaa6b80",
            measurementId: "G-T122J8B1CK"
        };

        let db, auth;
        try {
            if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, inMemoryPersistence);
                await signInAnonymously(auth);
                console.log("Firebase initialized and user signed in anonymously.");
            } else {
                console.warn("Firebase 설정이 필요합니다. 리더보드 기능이 비활성화됩니다.");
                db = null;
                auth = null;
            }
        } catch (e) {
            console.error("Firebase 초기화 실패:", e);
            db = null;
            auth = null;
        }

        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverModal = document.getElementById('game-over-modal');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const tutorialModal = document.getElementById('tutorial-modal');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const encryptedWordEl = document.getElementById('encrypted-word');
        const originalWordDisplay = document.getElementById('original-word-display');
        const answerInput = document.getElementById('answer-input');
        const finalScoreEl = document.getElementById('final-score');
        const innerWheel = document.getElementById('inner-wheel');
        const problemArea = document.getElementById('problem-area');
        const problemKeyDisplay = document.getElementById('problem-key-display');
        const decreaseShiftBtn = document.getElementById('decrease-shift');
        const increaseShiftBtn = document.getElementById('increase-shift');
        const userShiftDisplayEl = document.getElementById('user-shift-display');
        const checkKeyBtn = document.getElementById('check-key-btn');
        const arrowDisplay = document.getElementById('arrow-display');
        const submitAnswerBtn = document.getElementById('submit-answer-btn');
        const actionGuidanceMessageEl = document.getElementById('action-guidance-message');

        const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const wordList = ["BALL", "BOOK", "CAKE", "DESK", "DOLL", "FISH", "FROG", "GIFT", "HAND", "KING", "LAMP", "LION", "MILK", "MOON", "PARK", "PLAY", "STAR", "TREE", "APPLE", "BREAD", "CHAIR", "CLOUD", "DREAM", "EARTH", "GREEN", "HAPPY", "HEART", "JUICE", "MOUSE", "MUSIC", "PIZZA", "SMILE", "SPOON", "TIGER", "WATER", "WORLD", "BANANA", "BUTTER", "CANDLE", "FAMILY", "FLOWER", "FRIEND", "KITTEN", "ORANGE", "PENCIL", "PURPLE", "SCHOOL", "SUMMER", "WINDOW", "YELLOW"];
        const profanityList = ["씨발", "시발", "새끼", "좆", "씹", "개", "지랄", "염병", "썅", "병신", "븅신", "쪼다", "찌질이", "허접", "좆밥", "좆까", "존나", "좆도", "아가리", "개새끼", "씨발새끼", "씹새끼", "호로새끼", "미친새끼", "개년", "썅년", "씨발년", "미친년", "개놈", "쌍놈", "씨발놈", "미친놈", "개자식", "양아치", "쓰레기", "걸레", "애미", "애비", "니애미", "니애비"];
        let score = 0;
        let timeLeft = 90;
        let gameMode = '';
        let timerInterval = null;
        let isGameActive = false;
        let currentWord = '';
        let currentShift = 0;
        let userShift = 0;
        let cumulativeAngle = 0;
        const anglePerShift = 360 / 26;
        let leaderboardData = [];
        let combo = 0;

        function createCipherWheel() {
            const outerWheel = document.querySelector('.outer-wheel');
            const innerWheel = document.querySelector('.inner-wheel');
            outerWheel.innerHTML = '';
            innerWheel.innerHTML = '';

            for (let i = 0; i < 26; i++) {
                const angle = (i / 26) * 360;
                const outerLetter = document.createElement('div');
                outerLetter.className = 'letter outer-letter';
                outerLetter.style.transform = `rotate(${angle}deg)`;
                outerLetter.innerHTML = `<span style="transform: rotate(${-angle}deg); display: inline-block;">${ALPHABET.toLowerCase()[i]}</span>`;
                outerWheel.appendChild(outerLetter);

                const innerLetter = document.createElement('div');
                innerLetter.className = 'letter inner-letter';
                innerLetter.style.transform = `rotate(${angle}deg)`;
                innerLetter.innerHTML = `<span class="inner-letter-text" data-angle="${angle}">${ALPHABET[i]}</span>`;
                innerWheel.appendChild(innerLetter);
            }
            updateCipherWheel();
        }

        function updateCipherWheel() {
            innerWheel.style.transform = `translate(-50%, -50%) rotate(${cumulativeAngle}deg)`;
            const innerLetterTexts = document.querySelectorAll('.inner-letter-text');
            innerLetterTexts.forEach(textEl => {
                const initialAngle = parseFloat(textEl.dataset.angle);
                textEl.style.transform = `rotate(${-initialAngle - cumulativeAngle}deg)`;
            });
        }

        function updateShiftUI() {
            userShiftDisplayEl.textContent = `이동 값: +${userShift}`;
            updateCipherWheel();
            
            if (!isGameActive) return;

            // '타임어택' 모드에서만 키 일치 여부를 확인하여 입력창을 제어
            if (gameMode === 'time-attack') {
                 if (userShift === currentShift) {
                    answerInput.disabled = false;
                    answerInput.placeholder = '정답 입력';
                    answerInput.focus();
                    actionGuidanceMessageEl.textContent = '✅ 이제 정답을 입력하세요!';
                    actionGuidanceMessageEl.classList.add('text-green-500');
                    actionGuidanceMessageEl.classList.remove('text-gray-500');
                } else {
                    answerInput.disabled = true;
                    answerInput.placeholder = '';
                    actionGuidanceMessageEl.textContent = '이동 값을 문제의 키에 맞추세요!';
                    actionGuidanceMessageEl.classList.remove('text-green-500');
                    actionGuidanceMessageEl.classList.add('text-gray-500');
                }
            }
        }

        function caesarCipher(str, shift) {
            return str.toUpperCase().split('').map(char => {
                const charCode = char.charCodeAt(0);
                if (charCode >= 65 && charCode <= 90) {
                    return String.fromCharCode(((charCode - 65 + shift) % 26) + 65);
                }
                return char;
            }).join('');
        }
        
        function calculatePoints() {
            if (combo >= 15) return 7;
            if (combo >= 10) return 5;
            if (combo >= 5) return 3;
            return 1;
        }

        function updateComboDisplay() {
            const comboEl = document.getElementById('combo-display');
            if (combo >= 2) {
                comboEl.textContent = `🔥 ${combo} COMBO!`;
                comboEl.classList.remove('hidden');
                comboEl.classList.add('combo-pop-animation');
                setTimeout(() => {
                    comboEl.classList.remove('combo-pop-animation');
                }, 300);
            } else {
                comboEl.classList.add('hidden');
            }
        }

        async function fetchLeaderboardForMotivation(mode) {
            if (!db) {
                leaderboardData = [];
                return;
            }
            try {
                const collectionPath = `leaderboard-${mode}`;
                const scores = [];
                const q = query(collection(db, collectionPath), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach(doc => scores.push(doc.data()));
                leaderboardData = scores;
            } catch (e) {
                console.error("동기부여 리더보드 로딩 실패:", e);
                leaderboardData = [];
            }
        }

        function updateMotivationalMessage() {
            const messageEl = document.getElementById('motivational-message');
            if (!db || leaderboardData.length === 0) {
                messageEl.textContent = '리더보드의 첫 주인공이 되어보세요!';
                return;
            }

            let nextTarget = null;
            for (const entry of leaderboardData) {
                if (entry.score > score) {
                    nextTarget = entry;
                } else {
                    break;
                }
            }

            if (nextTarget) {
                const pointsNeeded = nextTarget.score - score + 1;
                messageEl.textContent = `🔥 ${pointsNeeded}점만 더! '${nextTarget.name}'님을 이길 수 있어요!`;
            } else {
                messageEl.textContent = '🏆 당신이 1위입니다! 새로운 기록을 세워보세요!';
            }
        }

        function goToMainMenu() {
            gameScreen.classList.add('hidden');
            hideModal(gameOverModal);
            hideModal(leaderboardModal);
            hideModal(tutorialModal);
            modeSelectionScreen.classList.remove('hidden');

            if (isGameActive) {
                isGameActive = false;
                clearInterval(timerInterval);
            }
        }

        async function startGame(mode) {
            gameMode = mode;
            score = 0;
            timeLeft = 90;
            isGameActive = true;
            combo = 0;
            updateComboDisplay();

            scoreEl.textContent = score;
            timerEl.textContent = timeLeft;
            
            document.getElementById('motivational-message').textContent = '리더보드 정보 로딩 중...';
            await fetchLeaderboardForMotivation(gameMode);
            updateMotivationalMessage();

            cumulativeAngle = 0;
            userShift = 0;

            modeSelectionScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            hideModal(gameOverModal);

            // UI 요소 제어
            answerInput.style.display = (mode === 'time-attack') ? 'block' : 'none';
            submitAnswerBtn.style.display = (mode === 'time-attack') ? 'block' : 'none';
            checkKeyBtn.style.display = (mode === 'find-key') ? 'block' : 'none';

            problemKeyDisplay.style.display = (mode === 'time-attack') ? 'inline-block' : 'none';
            originalWordDisplay.style.display = (mode === 'find-key') ? 'block' : 'none';
            arrowDisplay.style.display = (mode === 'find-key') ? 'block' : 'none';
            
            actionGuidanceMessageEl.textContent = ''; // 안내 메시지 초기화
            actionGuidanceMessageEl.classList.remove('hidden');


            if (mode === 'time-attack') {
                document.getElementById('instruction').innerHTML = "주어진 <strong>키</strong>에 이동 값을 맞추고, 암호문을 해독하세요.";
                nextQuestion_TimeAttack();
            } else { // find-key
                document.getElementById('instruction').innerHTML = "주어진 암호문을 평문으로 바꾸는 <strong>키</strong>를 찾으세요.";
                nextQuestion_FindKey();
            }

            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            timeLeft--;
            timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                endGame();
            }
        }

        function endGame() {
            isGameActive = false;
            clearInterval(timerInterval);
            finalScoreEl.textContent = score;
            const submitButton = document.getElementById('submit-score');
            const nameInput = document.getElementById('leaderboard-name');
            if (!db) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                nameInput.placeholder = "리더보드 비활성화";
                nameInput.disabled = true;
            } else {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                nameInput.placeholder = "리더보드에 등록할 이름";
                nameInput.disabled = false;
            }
            showModal(gameOverModal);
        }

        function nextQuestion_TimeAttack() {
            cumulativeAngle = Math.round(cumulativeAngle / 360) * 360;
            userShift = 0;
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            currentShift = Math.floor(Math.random() * 25) + 1;
            const encrypted = caesarCipher(currentWord, currentShift);

            encryptedWordEl.textContent = encrypted;
            problemKeyDisplay.textContent = `키: +${currentShift}`;
            answerInput.value = '';

            updateShiftUI(); // UI를 잠금 상태로 초기화
        }

        function checkAnswer_TimeAttack() {
            if (!isGameActive || answerInput.disabled) return;
            const isCorrect = answerInput.value.toUpperCase() === currentWord;
            if (isCorrect) {
                combo++;
                score += calculatePoints();
                scoreEl.textContent = score;
                updateMotivationalMessage();
                updateComboDisplay();
                problemArea.classList.add('feedback-correct');
                setTimeout(() => problemArea.classList.remove('feedback-correct'), 500);
                nextQuestion_TimeAttack();
            } else {
                combo = 0;
                updateComboDisplay();
                problemArea.classList.add('feedback-incorrect');
                setTimeout(() => problemArea.classList.remove('feedback-incorrect'), 500);
            }
        }

        function nextQuestion_FindKey() {
            cumulativeAngle = Math.round(cumulativeAngle / 360) * 360;
            userShift = 0;
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            currentShift = Math.floor(Math.random() * 25) + 1;
            const encrypted = caesarCipher(currentWord, currentShift);

            encryptedWordEl.textContent = encrypted;
            originalWordDisplay.textContent = currentWord;

            updateShiftUI(); 
        }

        function checkAnswer_FindKey() {
            if (!isGameActive) return;
            const isCorrect = userShift === currentShift;
            if (isCorrect) {
                combo++;
                score += calculatePoints();
                scoreEl.textContent = score;
                updateMotivationalMessage();
                updateComboDisplay();
                problemArea.classList.add('feedback-correct');
                setTimeout(() => problemArea.classList.remove('feedback-correct'), 500);
                nextQuestion_FindKey();
            } else {
                combo = 0;
                updateComboDisplay();
                problemArea.classList.add('feedback-incorrect');
                setTimeout(() => problemArea.classList.remove('feedback-incorrect'), 500);
            }
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModal(modal) {
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        async function submitScore() {
            const nameInput = document.getElementById('leaderboard-name');
            const name = nameInput.value.trim();

            if (!name) { alert("이름을 입력해주세요."); return; }
            if (name.length < 2 || name.length > 10) { alert("이름은 2자 이상 10자 이하로 입력해주세요."); return; }
            const lowerCaseName = name.toLowerCase();
            for (const badWord of profanityList) {
                if (lowerCaseName.includes(badWord)) {
                    alert("부적절한 단어가 포함된 이름은 사용할 수 없습니다.");
                    nameInput.value = '';
                    return;
                }
            }

            if (!db) { console.error("Firestore is not initialized."); alert("점수 등록에 실패했습니다."); return; }

            try {
                const collectionPath = `leaderboard-${gameMode}`;
                await addDoc(collection(db, collectionPath), { name, score, timestamp: new Date() });
                document.getElementById('leaderboard-name').value = '';
                fetchAndShowLeaderboard();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("리더보드 등록에 실패했습니다.");
            }
        }

        async function fetchAndShowLeaderboard() {
            showModal(leaderboardModal);
            const content = document.getElementById('leaderboard-content');
            if (!db) {
                content.innerHTML = '<p class="text-center text-red-500">리더보드 기능을 사용할 수 없습니다.</p>';
                return;
            }
            content.innerHTML = '<p class="text-center text-gray-500">로딩 중...</p>';

            try {
                const timeAttackPath = `leaderboard-time-attack`;
                const findKeyPath = `leaderboard-find-key`;

                const fetchScores = async (path) => {
                    const scoresData = [];
                    const q = query(collection(db, path), orderBy("score", "desc"), limit(10));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => scoresData.push(doc.data()));
                    return scoresData;
                };

                const [timeAttackScores, findKeyScores] = await Promise.all([fetchScores(timeAttackPath), fetchScores(findKeyPath)]);

                let html = '<div class="space-y-4">';
                const buildHtml = (title, scores) => {
                    let sectionHtml = `<div><h3 class="font-bold text-lg mb-2">${title}</h3>`;
                    if (scores.length > 0) {
                        sectionHtml += '<ol class="list-decimal list-inside space-y-1">';
                        scores.forEach(s => { sectionHtml += `<li><span class="font-semibold">${s.name}</span>: ${s.score}점</li>`; });
                        sectionHtml += '</ol>';
                    } else {
                        sectionHtml += '<p class="text-gray-500">아직 기록이 없습니다.</p>';
                    }
                    return sectionHtml + '</div>';
                };

                html += buildHtml('⏰ 타임어택 모드', timeAttackScores);
                html += buildHtml('🔑 키 찾기 모드', findKeyScores);
                html += '</div>';
                content.innerHTML = html;

            } catch (e) {
                console.error("Error fetching leaderboard: ", e);
                content.innerHTML = '<p class="text-center text-red-500">리더보드를 불러오는 데 실패했습니다.</p>';
            }
        }

        function shareScore() {
            const textToCopy = `[카이사르 암호 챌린지]에서 ${score}점을 달성했어요!`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const toast = document.getElementById('share-toast');
                toast.classList.remove('hidden');
                setTimeout(() => { toast.classList.add('hidden'); }, 2000);
            }).catch(err => {
                console.error('클립보드 복사 실패: ', err);
                alert("공유 링크 복사에 실패했습니다.");
            });
        }

        // History API integration
        window.onpopstate = function (event) {
            goToMainMenu();
        };

        if (location.hash) {
            history.replaceState(null, '', window.location.pathname);
        }

        document.getElementById('start-time-attack').addEventListener('click', () => {
            history.pushState({ view: 'game' }, '', '#game');
            startGame('time-attack');
        });
        document.getElementById('start-find-key').addEventListener('click', () => {
            history.pushState({ view: 'game' }, '', '#game');
            startGame('find-key');
        });

        document.getElementById('play-again').addEventListener('click', () => {
            history.back();
        });

        answerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') checkAnswer_TimeAttack(); });

        decreaseShiftBtn.addEventListener('click', () => {
            userShift = (userShift - 1 + 26) % 26;
            cumulativeAngle += anglePerShift;
            updateShiftUI();
        });
        increaseShiftBtn.addEventListener('click', () => {
            userShift = (userShift + 1) % 26;
            cumulativeAngle -= anglePerShift;
            updateShiftUI();
        });

        checkKeyBtn.addEventListener('click', checkAnswer_FindKey);
        submitAnswerBtn.addEventListener('click', checkAnswer_TimeAttack);
        document.getElementById('submit-score').addEventListener('click', submitScore);
        document.getElementById('share-score').addEventListener('click', shareScore);

        // From Game Over Modal
        document.getElementById('show-leaderboard').addEventListener('click', () => {
            fetchAndShowLeaderboard();
            history.pushState({ view: 'leaderboard' }, '', '#leaderboard');
        });

        // From Main Menu
        document.getElementById('show-leaderboard-main').addEventListener('click', () => {
            fetchAndShowLeaderboard();
            history.pushState({ view: 'leaderboard' }, '', '#leaderboard');
        });

        document.getElementById('close-leaderboard').addEventListener('click', () => history.back());

        document.getElementById('show-tutorial').addEventListener('click', () => {
            showModal(tutorialModal);
            history.pushState({ view: 'tutorial' }, '', '#tutorial');
        });
        document.getElementById('close-tutorial').addEventListener('click', () => history.back());

        createCipherWheel();
    </script>

    <footer class="p-4 text-center">
        <a href="privacy.html" target="_blank" class="text-xs text-gray-400 hover:text-gray-600 underline">개인정보 처리방침</a>
    </footer>
</body>

</html>
