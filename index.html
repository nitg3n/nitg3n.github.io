<!-- index.html -->

<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ì´ì‚¬ë¥´ ì•”í˜¸íŒ ì±Œë¦°ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            touch-action: manipulation;
            background-color: #f0f2f5;
            background-image: linear-gradient(135deg, #e9ecf2 0%, #f7f8fa 100%);
        }

        .cipher-wheel-container {
            position: relative;
            width: 320px;
            height: 320px;
        }

        .cipher-wheel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .outer-wheel {
            background-color: #f7fafc;
            border: 2px solid #a0aec0;
            width: 100%;
            height: 100%;
        }

        .inner-wheel {
            background-color: #cbd5e0;
            width: 75%;
            height: 75%;
            border: 2px solid #718096;
            transition: transform 0.4s ease-in-out;
        }

        .letter {
            position: absolute;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            padding-top: 8px;
            width: 24px;
            height: 320px;
            top: 0;
            left: calc(50% - 12px);
            transform-origin: center center;
            color: #2d3748;
        }

        .outer-letter>span {
            color: #4a5568;
        }

        .inner-letter {
            height: 240px;
        }

        .inner-letter-text {
            display: inline-block;
            transition: transform 0.4s ease-in-out;
        }

        .key-display {
            background-color: #edf2f7;
            border-radius: 9999px;
            padding: 8px 16px;
            font-weight: 700;
            color: #2d3748;
            border: 2px solid #cbd5e0;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .btn {
            @apply px-6 py-3 rounded-lg font-bold text-white shadow-md transition-all duration-300 transform;
        }

        .btn-blue {
            @apply bg-blue-500 hover:bg-blue-600 active:scale-95;
        }

        .btn-green {
            @apply bg-green-500 hover:bg-green-600 active:scale-95;
        }

        .btn-gray {
            @apply bg-gray-500 hover:bg-gray-600 active:scale-95;
        }

        .btn-teal {
            @apply bg-teal-500 hover:bg-teal-600 active:scale-95;
        }

        .name-input:focus {
            @apply ring-2 ring-blue-400 border-transparent;
        }

        .feedback-correct {
            animation: correct-pulse 0.5s;
        }

        .feedback-incorrect {
            animation: incorrect-shake 0.5s;
        }

        .btn-control {
            @apply w-12 h-12 rounded-full bg-gray-300 hover:bg-gray-400 text-gray-800 text-2xl font-bold flex items-center justify-center transition-all duration-200 active:scale-90;
        }

        @keyframes correct-pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes incorrect-shake {

            0%,
            100% {
                transform: translateX(0);
            }

            10%,
            30%,
            50%,
            70%,
            90% {
                transform: translateX(-5px);
            }

            20%,
            40%,
            60%,
            80% {
                transform: translateX(5px);
            }
        }
    </style>
</head>

<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-md mx-auto text-center">

        <!-- ê²Œì„ ëª¨ë“œ ì„ íƒ í™”ë©´ -->
        <div id="mode-selection-screen" class="bg-white p-8 rounded-2xl shadow-lg">
            <h1 class="text-4xl font-bold mb-2 text-gray-700">ì¹´ì´ì‚¬ë¥´ ì•”í˜¸ ì±Œë¦°ì§€</h1>
            <p class="text-gray-500 mb-8">í”Œë ˆì´í•  ê²Œì„ ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
            <div class="space-y-4">
                <button id="start-time-attack" class="btn btn-blue w-full text-lg">
                    â° íƒ€ì„ì–´íƒ! ì•”í˜¸ í•´ë…
                </button>
                <button id="start-find-key" class="btn btn-teal w-full text-lg">
                    ğŸ”‘ í‚¤(Key)ë¥¼ ì°¾ì•„ë¼!
                </button>
                <button id="show-tutorial" class="btn btn-gray w-full text-lg">
                    ğŸ“– ê²Œì„ ë°©ë²•
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ ê²Œì„ í™”ë©´ -->
        <div id="game-screen" class="hidden bg-white p-6 md:p-8 rounded-2xl shadow-lg">
            <!-- í—¤ë”: ì ìˆ˜ ë° íƒ€ì´ë¨¸ -->
            <div class="flex justify-between items-center mb-6">
                <div class="text-left">
                    <span class="text-gray-500">ì ìˆ˜</span>
                    <p id="score" class="text-3xl font-bold">0</p>
                </div>
                <div class="text-right">
                    <span class="text-gray-500">ë‚¨ì€ ì‹œê°„</span>
                    <p id="timer" class="text-3xl font-bold">60</p>
                </div>
            </div>

            <!-- ì¹´ì´ì‚¬ë¥´ ì•”í˜¸íŒ -->
            <div class="cipher-wheel-container mx-auto mb-4">
                <div class="cipher-wheel outer-wheel"></div>
                <div id="inner-wheel" class="cipher-wheel inner-wheel"></div>
            </div>

            <!-- ì‰¬í”„íŠ¸ ì¡°ì‘ ì»¨íŠ¸ë¡¤ -->
            <div id="shift-control" class="flex items-center justify-center space-x-4 mb-6">
                <button id="decrease-shift" class="btn-control">-</button>
                <span id="user-shift-display" class="key-display text-lg">Shift: +0</span>
                <button id="increase-shift" class="btn-control">+</button>
            </div>

            <!-- ë¬¸ì œ í‘œì‹œ ì˜ì—­ -->
            <div id="problem-area" class="mb-6">
                <p id="instruction" class="text-gray-500 mb-2"></p>
                <p id="problem-key-display" class="key-display text-lg mb-4 inline-block hidden">Key: +3</p>
                <div class="flex items-center justify-center space-x-2">
                    <p id="encrypted-word" class="text-4xl font-bold tracking-widest bg-gray-100 p-4 rounded-lg"></p>
                    <div id="arrow-display" class="hidden">
                        <svg class="w-8 h-8 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                        </svg>
                    </div>
                    <p id="original-word-display"
                        class="text-4xl font-bold tracking-widest bg-green-100 p-4 rounded-lg hidden"></p>
                </div>
            </div>

            <!-- ì •ë‹µ ì…ë ¥ ì˜ì—­ -->
            <div id="answer-area">
                <input type="text" id="answer-input"
                    class="w-full p-4 text-2xl text-center border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 transition"
                    placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off" autocapitalize="off">
                <ul id="answer-list" class="hidden space-y-2 max-h-64 overflow-y-auto"></ul>
                <button id="check-key-btn" class="btn btn-green w-full text-lg hidden">ì´ Keyë¡œ í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-sm p-8 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-3xl font-bold mb-2">ê²Œì„ ì¢…ë£Œ!</h2>
            <p class="text-lg mb-4">ìµœì¢… ì ìˆ˜: <span id="final-score" class="font-bold text-blue-500">0</span></p>
            <div class="mb-4">
                <input type="text" id="leaderboard-name"
                    class="name-input w-full p-3 text-center border-2 border-gray-300 rounded-lg focus:outline-none transition"
                    placeholder="ë¦¬ë”ë³´ë“œì— ë“±ë¡í•  ì´ë¦„">
                <button id="submit-score" class="btn btn-green w-full mt-2">ì ìˆ˜ ë“±ë¡</button>
            </div>
            <div class="flex space-x-2">
                <button id="play-again" class="btn btn-blue flex-1">ë‹¤ì‹œí•˜ê¸°</button>
                <button id="share-score" class="btn btn-teal flex-1">ê³µìœ í•˜ê¸°</button>
            </div>
            <button id="show-leaderboard" class="btn btn-gray w-full mt-2">ë¦¬ë”ë³´ë“œ ë³´ê¸°</button>
        </div>
    </div>
    <div id="leaderboard-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-sm p-6 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-4">ğŸ† ë¦¬ë”ë³´ë“œ ğŸ†</h2>
            <div id="leaderboard-content" class="text-left max-h-80 overflow-y-auto">
                <p class="text-center text-gray-500">ë¡œë”© ì¤‘...</p>
            </div>
            <button id="close-leaderboard" class="btn btn-gray w-full mt-4">ë‹«ê¸°</button>
        </div>
    </div>
    <div id="tutorial-modal" class="hidden modal-backdrop">
        <div
            class="bg-white w-11/12 max-w-md p-8 rounded-2xl shadow-xl text-center transform transition-all scale-95 opacity-0">
            <h2 class="text-3xl font-bold mb-4">ğŸ“– ê²Œì„ ë°©ë²•</h2>
            <div class="text-left space-y-6 text-gray-700">
                <div>
                    <strong class="text-blue-500 text-xl">â° íƒ€ì„ì–´íƒ! ì•”í˜¸ í•´ë…</strong>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>í™”ë©´ì— ë‚˜íƒ€ë‚œ <strong class="font-mono bg-gray-200 px-1 rounded">ì•”í˜¸ë¬¸</strong>ê³¼ <strong
                                class="font-mono bg-gray-200 px-1 rounded">Key(Shift ê°’)</strong>ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</li>
                        <li>ì£¼ì–´ì§„ Keyì— ë§ê²Œ ì•”í˜¸íŒì„ ì¡°ì‘í•˜ê±°ë‚˜ ì•”ì‚°í•˜ì—¬ ì›ë³¸ ë‹¨ì–´ë¥¼ í•´ë…í•©ë‹ˆë‹¤.</li>
                        <li>í•´ë…í•œ ë‹¨ì–´ë¥¼ ë¹ ë¥´ê²Œ ì…ë ¥í•˜ì—¬ ì ìˆ˜ë¥¼ ì–»ìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
                <div>
                    <strong class="text-teal-500 text-xl">ğŸ”‘ í‚¤(Key)ë¥¼ ì°¾ì•„ë¼!</strong>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li><strong class="font-mono bg-gray-200 px-1 rounded">ì•”í˜¸ë¬¸</strong>ê³¼ <strong
                                class="font-mono bg-green-200 px-1 rounded">ì›ë³¸ ë‹¨ì–´(í‰ë¬¸)</strong>ê°€ í•¨ê»˜ ì£¼ì–´ì§‘ë‹ˆë‹¤.</li>
                        <li>ì•”í˜¸íŒì„ <strong class="font-mono bg-gray-200 px-1 rounded">+</strong> / <strong
                                class="font-mono bg-gray-200 px-1 rounded">-</strong> ë²„íŠ¼ìœ¼ë¡œ ëŒë ¤ ì•”í˜¸í™”ì— ì‚¬ìš©ëœ Keyë¥¼ ì°¾ìŠµë‹ˆë‹¤.</li>
                        <li>ì˜¬ë°”ë¥¸ Keyë¥¼ ì°¾ì•˜ë‹¤ë©´ 'ì´ Keyë¡œ í™•ì¸' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì ìˆ˜ë¥¼ ì–»ìŠµë‹ˆë‹¤.</li>
                    </ul>
                </div>
            </div>
            <button id="close-tutorial" class="btn btn-blue w-full mt-8">ì´í•´í–ˆì–´ìš”!</button>
        </div>
    </div>
    <div id="share-toast"
        class="hidden fixed bottom-10 left-1/2 -translate-x-12 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg text-sm">
        í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, setPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArTDw-8Gw9wjhQbhWySalh1kS7_heePRY",
            authDomain: "ceaser-board.firebaseapp.com",
            projectId: "ceaser-board",
            storageBucket: "ceaser-board.firebasestorage.app",
            messagingSenderId: "597014903425",
            appId: "1:597014903425:web:e85e8f9e4bea419aaa6b80",
            measurementId: "G-T122J8B1CK"
        };

        let db, auth;
        try {
            if (firebaseConfig && firebaseConfig.projectId && firebaseConfig.projectId !== "YOUR_PROJECT_ID") {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, inMemoryPersistence);
                await signInAnonymously(auth);
                console.log("Firebase initialized and user signed in anonymously.");
            } else {
                console.warn("Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¦¬ë”ë³´ë“œ ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.");
                db = null;
                auth = null;
            }
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            db = null;
            auth = null;
        }

        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameOverModal = document.getElementById('game-over-modal');
        const leaderboardModal = document.getElementById('leaderboard-modal');
        const tutorialModal = document.getElementById('tutorial-modal');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const encryptedWordEl = document.getElementById('encrypted-word');
        const originalWordDisplay = document.getElementById('original-word-display');
        const answerInput = document.getElementById('answer-input');
        const finalScoreEl = document.getElementById('final-score');
        const innerWheel = document.getElementById('inner-wheel');
        const problemArea = document.getElementById('problem-area');
        const problemKeyDisplay = document.getElementById('problem-key-display');
        const decreaseShiftBtn = document.getElementById('decrease-shift');
        const increaseShiftBtn = document.getElementById('increase-shift');
        const userShiftDisplayEl = document.getElementById('user-shift-display');
        const checkKeyBtn = document.getElementById('check-key-btn');
        const arrowDisplay = document.getElementById('arrow-display');

        const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        EASY_WORDS = ["BALL", "BOOK", "CAKE", "DESK", "DOLL", "FISH", "FROG", "GIFT", "HAND", "KING", "LAMP", "LION", "MILK", "MOON", "PARK", "PLAY", "STAR", "TREE", "APPLE", "BREAD", "CHAIR", "CLOUD", "DREAM", "EARTH", "GREEN", "HAPPY", "HEART", "JUICE", "MOUSE", "MUSIC", "PIZZA", "SMILE", "SPOON", "TIGER", "WATER", "WORLD", "BANANA", "BUTTER", "CANDLE", "FAMILY", "FLOWER", "FRIEND", "KITTEN", "ORANGE", "PENCIL", "PURPLE", "SCHOOL", "SUMMER", "WINDOW", "YELLOW"];
        const profanityList = ["ì”¨ë°œ", "ì‹œë°œ", "ìƒˆë¼", "ì¢†", "ì”¹", "ê°œ", "ì§€ë„", "ì—¼ë³‘", "ì…", "ë³‘ì‹ ", "ë¸…ì‹ ", "ìª¼ë‹¤", "ì°Œì§ˆì´", "í—ˆì ‘", "ì¢†ë°¥", "ì¢†ê¹Œ", "ì¡´ë‚˜", "ì¢†ë„", "ì•„ê°€ë¦¬", "ê°œìƒˆë¼", "ì”¨ë°œìƒˆë¼", "ì”¹ìƒˆë¼", "í˜¸ë¡œìƒˆë¼", "ë¯¸ì¹œìƒˆë¼", "ê°œë…„", "ì…ë…„", "ì”¨ë°œë…„", "ë¯¸ì¹œë…„", "ê°œë†ˆ", "ìŒë†ˆ", "ì”¨ë°œë†ˆ", "ë¯¸ì¹œë†ˆ", "ê°œìì‹", "ì–‘ì•„ì¹˜", "ì“°ë ˆê¸°", "ê±¸ë ˆ", "ì• ë¯¸", "ì• ë¹„", "ë‹ˆì• ë¯¸", "ë‹ˆì• ë¹„"];
        let score = 0;
        let timeLeft = 60;
        let gameMode = '';
        let timerInterval = null;
        let isGameActive = false;
        let currentWord = '';
        let currentShift = 0;
        let userShift = 0;
        let cumulativeAngle = 0;
        const anglePerShift = 360 / 26;

        function createCipherWheel() {
            const outerWheel = document.querySelector('.outer-wheel');
            const innerWheel = document.querySelector('.inner-wheel');
            outerWheel.innerHTML = '';
            innerWheel.innerHTML = '';

            for (let i = 0; i < 26; i++) {
                const angle = (i / 26) * 360;
                const outerLetter = document.createElement('div');
                outerLetter.className = 'letter outer-letter';
                outerLetter.style.transform = `rotate(${angle}deg)`;
                outerLetter.innerHTML = `<span style="transform: rotate(${-angle}deg); display: inline-block;">${ALPHABET.toLowerCase()[i]}</span>`;
                outerWheel.appendChild(outerLetter);

                const innerLetter = document.createElement('div');
                innerLetter.className = 'letter inner-letter';
                innerLetter.style.transform = `rotate(${angle}deg)`;
                innerLetter.innerHTML = `<span class="inner-letter-text" data-angle="${angle}">${ALPHABET[i]}</span>`;
                innerWheel.appendChild(innerLetter);
            }
            updateCipherWheel();
        }

        function updateCipherWheel() {
            innerWheel.style.transform = `translate(-50%, -50%) rotate(${cumulativeAngle}deg)`;
            const innerLetterTexts = document.querySelectorAll('.inner-letter-text');
            innerLetterTexts.forEach(textEl => {
                const initialAngle = parseFloat(textEl.dataset.angle);
                textEl.style.transform = `rotate(${-initialAngle - cumulativeAngle}deg)`;
            });
        }

        function updateShiftUI() {
            userShiftDisplayEl.textContent = `Shift: +${userShift}`;
            updateCipherWheel();
        }

        function caesarCipher(str, shift) {
            return str.toUpperCase().split('').map(char => {
                const charCode = char.charCodeAt(0);
                if (charCode >= 65 && charCode <= 90) {
                    return String.fromCharCode(((charCode - 65 + shift) % 26) + 65);
                }
                return char;
            }).join('');
        }

        function startGame(mode) {
            gameMode = mode;
            score = 0;
            timeLeft = 60;
            isGameActive = true;

            scoreEl.textContent = score;
            timerEl.textContent = timeLeft;

            cumulativeAngle = 0;
            userShift = 0;
            updateShiftUI();

            modeSelectionScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            hideModal(gameOverModal);

            if (mode === 'time-attack') {
                answerInput.style.display = 'block';
                checkKeyBtn.classList.add('hidden');
                problemKeyDisplay.classList.remove('hidden');
                originalWordDisplay.classList.add('hidden');
                arrowDisplay.classList.add('hidden');
                document.getElementById('instruction').textContent = "ì£¼ì–´ì§„ Keyë¡œ ì•”í˜¸ë¬¸ì„ í•´ë…í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”.";
                nextQuestion_TimeAttack();
            } else { // find-key
                answerInput.style.display = 'none';
                checkKeyBtn.classList.remove('hidden');
                problemKeyDisplay.classList.add('hidden');
                originalWordDisplay.classList.remove('hidden');
                arrowDisplay.classList.remove('hidden');
                document.getElementById('instruction').textContent = "ì•”í˜¸ë¬¸ì„ í‰ë¬¸ìœ¼ë¡œ ë°”ê¾¸ëŠ” Keyë¥¼ ì°¾ìœ¼ì„¸ìš”.";
                nextQuestion_FindKey();
            }

            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            timeLeft--;
            timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                endGame();
            }
        }

        function endGame() {
            isGameActive = false;
            clearInterval(timerInterval);
            finalScoreEl.textContent = score;
            const submitButton = document.getElementById('submit-score');
            const nameInput = document.getElementById('leaderboard-name');
            if (!db) {
                submitButton.disabled = true;
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                nameInput.placeholder = "ë¦¬ë”ë³´ë“œ ë¹„í™œì„±í™”";
                nameInput.disabled = true;
            } else {
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                nameInput.placeholder = "ë¦¬ë”ë³´ë“œì— ë“±ë¡í•  ì´ë¦„";
                nameInput.disabled = false;
            }
            showModal(gameOverModal);
        }

        function playAgain() {
            hideModal(gameOverModal);
            hideModal(leaderboardModal);
            modeSelectionScreen.classList.remove('hidden');
            gameScreen.classList.add('hidden');
        }

        function nextQuestion_TimeAttack() {
            cumulativeAngle = Math.round(cumulativeAngle / 360) * 360;
            userShift = 0;
            updateShiftUI();
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            currentShift = Math.floor(Math.random() * 25) + 1;
            const encrypted = caesarCipher(currentWord, currentShift);

            encryptedWordEl.textContent = encrypted;
            problemKeyDisplay.textContent = `Key: +${currentShift}`;
            answerInput.value = '';
            answerInput.focus();
        }

        function checkAnswer_TimeAttack() {
            if (!isGameActive) return;
            const isCorrect = answerInput.value.toUpperCase() === currentWord;
            if (isCorrect) {
                score++;
                scoreEl.textContent = score;
                problemArea.classList.add('feedback-correct');
                setTimeout(() => problemArea.classList.remove('feedback-correct'), 500);
                nextQuestion_TimeAttack();
            } else {
                problemArea.classList.add('feedback-incorrect');
                setTimeout(() => problemArea.classList.remove('feedback-incorrect'), 500);
            }
        }

        function nextQuestion_FindKey() {
            cumulativeAngle = Math.round(cumulativeAngle / 360) * 360;
            userShift = 0;
            updateShiftUI();
            currentWord = wordList[Math.floor(Math.random() * wordList.length)];
            currentShift = Math.floor(Math.random() * 25) + 1;
            const encrypted = caesarCipher(currentWord, currentShift);

            encryptedWordEl.textContent = encrypted;
            originalWordDisplay.textContent = currentWord;
        }

        function checkAnswer_FindKey() {
            if (!isGameActive) return;
            const isCorrect = userShift === currentShift;
            if (isCorrect) {
                score++;
                scoreEl.textContent = score;
                problemArea.classList.add('feedback-correct');
                setTimeout(() => problemArea.classList.remove('feedback-correct'), 500);
                nextQuestion_FindKey();
            } else {
                problemArea.classList.add('feedback-incorrect');
                setTimeout(() => problemArea.classList.remove('feedback-incorrect'), 500);
            }
        }

        function showModal(modal) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('div').classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function hideModal(modal) {
            modal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        async function submitScore() {
            const nameInput = document.getElementById('leaderboard-name');
            const name = nameInput.value.trim();

            if (!name) { alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            if (name.length < 2 || name.length > 10) { alert("ì´ë¦„ì€ 2ì ì´ìƒ 10ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            const lowerCaseName = name.toLowerCase();
            for (const badWord of profanityList) {
                if (lowerCaseName.includes(badWord)) {
                    alert("ë¶€ì ì ˆí•œ ë‹¨ì–´ê°€ í¬í•¨ëœ ì´ë¦„ì€ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    nameInput.value = '';
                    return;
                }
            }

            if (!db) { console.error("Firestore is not initialized."); alert("ì ìˆ˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); return; }

            try {
                const collectionPath = `leaderboard-${gameMode}`;
                await addDoc(collection(db, collectionPath), { name, score, timestamp: new Date() });
                document.getElementById('leaderboard-name').value = '';
                fetchAndShowLeaderboard();
            } catch (e) {
                console.error("Error adding document: ", e);
                alert("ë¦¬ë”ë³´ë“œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function fetchAndShowLeaderboard() {
            showModal(leaderboardModal);
            const content = document.getElementById('leaderboard-content');
            if (!db) {
                content.innerHTML = '<p class="text-center text-red-500">ë¦¬ë”ë³´ë“œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            content.innerHTML = '<p class="text-center text-gray-500">ë¡œë”© ì¤‘...</p>';

            try {
                const timeAttackPath = `leaderboard-time-attack`;
                const findKeyPath = `leaderboard-find-key`;

                const fetchScores = async (path) => {
                    const scoresData = [];
                    const q = query(collection(db, path), orderBy("score", "desc"), limit(10));
                    const querySnapshot = await getDocs(q);
                    querySnapshot.forEach(doc => scoresData.push(doc.data()));
                    return scoresData;
                };

                const [timeAttackScores, findKeyScores] = await Promise.all([fetchScores(timeAttackPath), fetchScores(findKeyPath)]);

                let html = '<div class="space-y-4">';
                const buildHtml = (title, scores) => {
                    let sectionHtml = `<div><h3 class="font-bold text-lg mb-2">${title}</h3>`;
                    if (scores.length > 0) {
                        sectionHtml += '<ol class="list-decimal list-inside space-y-1">';
                        scores.forEach(s => { sectionHtml += `<li><span class="font-semibold">${s.name}</span>: ${s.score}ì </li>`; });
                        sectionHtml += '</ol>';
                    } else {
                        sectionHtml += '<p class="text-gray-500">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    }
                    return sectionHtml + '</div>';
                };

                html += buildHtml('â° íƒ€ì„ì–´íƒ ëª¨ë“œ', timeAttackScores);
                html += buildHtml('ğŸ”‘ í‚¤ ì°¾ê¸° ëª¨ë“œ', findKeyScores);
                html += '</div>';
                content.innerHTML = html;

            } catch (e) {
                console.error("Error fetching leaderboard: ", e);
                content.innerHTML = '<p class="text-center text-red-500">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }

        function shareScore() {
            const textToCopy = `[ì¹´ì´ì‚¬ë¥´ ì•”í˜¸ ì±Œë¦°ì§€]ì—ì„œ ${score}ì ì„ ë‹¬ì„±í–ˆì–´ìš”!`;
            navigator.clipboard.writeText(textToCopy).then(() => {
                const toast = document.getElementById('share-toast');
                toast.classList.remove('hidden');
                setTimeout(() => { toast.classList.add('hidden'); }, 2000);
            }).catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨: ', err);
                alert("ê³µìœ  ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            });
        }

        document.getElementById('start-time-attack').addEventListener('click', () => startGame('time-attack'));
        document.getElementById('start-find-key').addEventListener('click', () => startGame('find-key'));
        document.getElementById('play-again').addEventListener('click', playAgain);
        answerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') checkAnswer_TimeAttack(); });
        decreaseShiftBtn.addEventListener('click', () => {
            userShift = (userShift - 1 + 26) % 26;
            cumulativeAngle += anglePerShift;
            updateShiftUI();
        });
        increaseShiftBtn.addEventListener('click', () => {
            userShift = (userShift + 1) % 26;
            cumulativeAngle -= anglePerShift;
            updateShiftUI();
        });
        checkKeyBtn.addEventListener('click', checkAnswer_FindKey);
        document.getElementById('submit-score').addEventListener('click', submitScore);
        document.getElementById('share-score').addEventListener('click', shareScore);
        document.getElementById('show-leaderboard').addEventListener('click', fetchAndShowLeaderboard);
        document.getElementById('close-leaderboard').addEventListener('click', () => hideModal(leaderboardModal));
        document.getElementById('show-tutorial').addEventListener('click', () => showModal(tutorialModal));
        document.getElementById('close-tutorial').addEventListener('click', () => hideModal(tutorialModal));

        createCipherWheel();
    </script>
</body>

</html>
